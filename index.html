<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Lumi Configurator</title>
    <style>
        :root {
            --bg: #ffffff;
            --square-bg: #1e293b;
            --square-border: #e2e8f0;
            --gap: 3px;
            --pad: 12px;
            --radius: 8px;
            --shadow: 0 10px 30px rgba(2, 6, 23, 0.1);
            --header-bg: #1e293b;
            --footer-bg: #1e293b;
            --text-light: #f8fafc;
            --accent: #3b82f6;
            --border-color: #334155;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            min-height: 100svh;
            margin: 0;
            display: flex;
            flex-direction: column;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
            color: #0b1220;
            background-color: var(--bg);
        }

        /* Header Styles */
        header {
            background-color: var(--header-bg);
            color: var(--text-light);
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background-color: var(--accent);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .btn-primary {
            background-color: var(--accent);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        /* Main Content Styles */
        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem;
        }

        .title {
            color: #1e293b;
            font-weight: 600;
            letter-spacing: 0.2px;
            margin-bottom: 2rem;
            text-align: center;
            font-size: 1.5rem;
        }

        /* The square container (columns only) */
        .square {
            width: min(92vmin, 520px);
            aspect-ratio: 1 / 1;
            border-radius: var(--radius);
            border: 1px solid var(--square-border);
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-auto-rows: 1fr;
            gap: var(--gap);
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }

        .box {
            border-radius: calc(var(--radius) - 8px);
            border: 1px solid #a1a1a1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            letter-spacing: .3px;
            background: linear-gradient(180deg, rgba(0, 0, 0, .02), rgba(0, 0, 0, .04));
            position: relative;
            overflow: hidden;
            padding: 20px 0;
            background-color: #e1e1e1;
            /* Default white background */
        }

        .box-top,
        .box-bottom {
            width: 100%;
            text-align: center;
            padding: 16px 0;
            font-weight: bold;
            font-size: clamp(10px, 2.5vw, 14px);
            min-height: 32px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            line-height: 1.2;
            color: white;
        }

        .icon-with-text-option {
            background-color: #98baff87;
        }

        .box-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
        }

        .box span {
            opacity: .65;
            font-size: 14px;
        }

        .box:hover {
            border-style: solid;
            background: linear-gradient(180deg, rgba(59, 130, 246, 0.05), rgba(59, 130, 246, 0.1));
        }

        /* Configuration Panel */
        .config-panel {
            background-color: white;
            border-radius: var(--radius);
            padding: 1.5rem;
            width: min(92vmin, 520px);
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            border: 1px solid #e2e8f0;
        }

        .config-section {
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .config-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #1e293b;
        }

        .color-options {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .color-option {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: transform 0.2s, border-color 0.2s;
        }

        .color-option:hover {
            transform: scale(1.1);
        }

        .color-option.selected {
            border-color: #1e293b;
            transform: scale(1.1);
        }

        .engraving-options {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .engraving-option {
            flex: 1;
            min-width: 120px;
            padding: 0.75rem;
            border: 1px solid #cbd5e1;
            border-radius: var(--radius);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .engraving-option:hover {
            border-color: var(--accent);
            background-color: rgba(59, 130, 246, 0.05);
        }

        .engraving-option.selected {
            border-color: var(--accent);
            background-color: rgba(59, 130, 246, 0.1);
        }

        .input-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .text-input {
            padding: 0.5rem;
            border: 1px solid #cbd5e1;
            border-radius: 4px;
            text-align: center;
            font-size: 0.9rem;
            width: 100%;
            box-sizing: border-box;
            max-width: 100%;
        }

        .icon-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .icon-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            border: 1px dashed #cbd5e1;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 80px;
            background-color: rgb(133, 177, 248);
        }

        .icon-option:hover {
            border-color: var(--accent);
            background-color: rgba(59, 130, 246, 0.05);
        }

        .icon-option.selected {
            border-color: var(--accent);
            background-color: rgba(0, 98, 255, 1);
        }

        .icon-plus {
            font-size: 1.5rem;
            font-weight: bold;
            color: #64748b;
        }

        .icon-text {
            font-size: 0.75rem;
            margin-top: 0.25rem;
            color: #ffffff;
        }

        .icon-with-text-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .icon-with-text-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            border: 1px dashed #cbd5e1;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 100px;
        }

        .icon-with-text-option:hover {
            border-color: var(--accent);
            background-color: rgba(59, 130, 246, 0.05);
        }

        .icon-with-text-option.selected {
            border-color: var(--accent);
            background-color: rgba(0, 98, 255, 1);
        }

        .icon-with-text-input {
            width: 100%;
            padding: 0.25rem;
            border: 1px solid #cbd5e1;
            border-radius: 4px;
            text-align: center;
            margin-top: 0.5rem;
            font-size: 0.75rem;
            max-width: 100%;
            box-sizing: border-box;
        }

        .save-btn-container {
            display: flex;
            justify-content: center;
            margin-top: 1.5rem;
        }

        .save-btn {
            padding: 0.75rem 2rem;
            background-color: #10b981;
            color: white;
            border: none;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .save-btn:hover {
            background-color: #059669;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            border-radius: var(--radius);
            width: min(95vw, 800px);
            height: min(80vh, 600px);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #64748b;
        }

        .close-modal:hover {
            color: #1e293b;
        }

        .icon-grid-modal {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 0.75rem;
            overflow-y: auto;
            flex: 1;
            padding: 0.5rem;
        }

        .icon-modal-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            aspect-ratio: 1 / 1;
            background-color: #000000;
        }

        .icon-modal-option:hover {
            border-color: var(--accent);
            background-color: #1e293b;
        }

        .icon-modal-option.selected {
            border-color: var(--accent);
            background-color: #1e293b;
        }

        .icon-preview {
            width: 48px;
            height: 48px;
            object-fit: contain;
            margin-bottom: 0.5rem;
        }

        .icon-number {
            font-size: 0.7rem;
            color: #ffffff;
        }

        /* Footer Styles */
        footer {
            background-color: var(--footer-bg);
            color: var(--text-light);
            padding: 2rem;
            border-top: 1px solid var(--border-color);
            text-align: center;
        }

        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
        }

        .copyright {
            margin-top: 1rem;
            color: #94a3b8;
            font-size: 0.9rem;
        }

        /* Loading state for icons */
        .icon-preview.loading {
            background-color: #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #64748b;
            font-size: 0.8rem;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .header-actions {
                width: 100%;
                justify-content: center;
            }

            .engraving-options {
                flex-direction: column;
            }

            .icon-grid-modal {
                grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            }
        }

        @media (max-width: 480px) {
            .icon-grid-modal {
                grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            }
        }
        /* Switch Label Modal Styles */
#switchLabelModal .modal-content {
    max-height: 400px;
    overflow: visible;
}

.modal-body {
    padding: 20px;
}
    </style>
</head>

<body>
    <header>
        <div class="header-content">
            <div class="logo">
                <span>Hexa Tactile Configurator</span>
            </div>
            <div class="header-actions">
                <button class="btn btn-primary" onclick="window.location.href='designs.html'">View Design</button>
            </div>
        </div>
    </header>

    <main>
        <h1 class="title">Engraving Style Configurator</h1>

        <div class="square">
            <div class="box" id="box1">
                <div class="box-top" id="box1-top"></div>
                <div class="box-content" id="box1-content"></div>
                <div class="box-bottom" id="box1-bottom"></div>
            </div>
            <div class="box" id="box2">
                <div class="box-top" id="box2-top"></div>
                <div class="box-content" id="box2-content"></div>
                <div class="box-bottom" id="box2-bottom"></div>
            </div>
            <div class="box" id="box3">
                <div class="box-top" id="box3-top"></div>
                <div class="box-content" id="box3-content"></div>
                <div class="box-bottom" id="box3-bottom"></div>
            </div>
        </div>

        <div class="config-panel">
            <div class="config-section">
                <h3 class="section-title">Select Color</h3>
                <div class="color-options">
                    <div class="color-option selected" style="background-color: #e1e1e1;" data-color="#e1e1e1"
                        data-name="White"></div>
                    <div class="color-option" style="background-color: #2f2524;" data-color="#2f2524"
                        data-name="Red Copper"></div>
                    <div class="color-option" style="background-color: #a39d87;" data-color="#a39d87" data-name="Amber">
                    </div>
                    <div class="color-option" style="background-color: #262626;" data-color="#262626" data-name="Black">
                    </div>
                    <div class="color-option" style="background-color: #3e3b28;" data-color="#3e3b28"
                        data-name="Bronze"></div>
                    <div class="color-option" style="background-color: #5e5e5e;" data-color="#5e5e5e" data-name="Grey">
                    </div>
                    <div class="color-option" style="background-color: #d2c6ac;" data-color="#d2c6ac"
                        data-name="Champagne"></div>
                </div>
            </div>

            <div class="config-section">
                <h3 class="section-title">Select Engraving Type</h3>
                <div class="engraving-options">
                    <div class="engraving-option selected" data-type="normal">Normal</div>
                    <div class="engraving-option" data-type="text">Text</div>
                    <div class="engraving-option" data-type="icon">Icon</div>
                    <div class="engraving-option" data-type="textWithIcon">Text With Icon</div>
                </div>

                <!-- Normal Engraving (hidden by default) -->
                <div id="normal-options" class="engraving-type-options">
                    <p>Normal engraving selected. Dashes will appear on top and bottom of each box.</p>
                </div>

                <!-- Text Engraving (hidden by default) -->
                <div id="text-options" class="engraving-type-options" style="display: none;">
                    <p>Enter text for each position (max 7 characters):</p>
                    <div class="input-grid">
                        <input type="text" class="text-input" placeholder="Text 1" data-position="1" maxlength="7">
                        <input type="text" class="text-input" placeholder="Text 2" data-position="2" maxlength="7">
                        <input type="text" class="text-input" placeholder="Text 3" data-position="3" maxlength="7">
                        <input type="text" class="text-input" placeholder="Text 4" data-position="4" maxlength="7">
                        <input type="text" class="text-input" placeholder="Text 5" data-position="5" maxlength="7">
                        <input type="text" class="text-input" placeholder="Text 6" data-position="6" maxlength="7">
                    </div>
                </div>

                <!-- Icon Engraving (hidden by default) -->
                <div id="icon-options" class="engraving-type-options" style="display: none;">
                    <p>Select icons for each position:</p>
                    <div class="icon-grid">
                        <div class="icon-option" data-position="1">
                            <div class="icon-plus">+</div>
                            <div class="icon-text">Icon 1</div>
                        </div>
                        <div class="icon-option" data-position="2">
                            <div class="icon-plus">+</div>
                            <div class="icon-text">Icon 2</div>
                        </div>
                        <div class="icon-option" data-position="3">
                            <div class="icon-plus">+</div>
                            <div class="icon-text">Icon 3</div>
                        </div>
                        <div class="icon-option" data-position="4">
                            <div class="icon-plus">+</div>
                            <div class="icon-text">Icon 4</div>
                        </div>
                        <div class="icon-option" data-position="5">
                            <div class="icon-plus">+</div>
                            <div class="icon-text">Icon 5</div>
                        </div>
                        <div class="icon-option" data-position="6">
                            <div class="icon-plus">+</div>
                            <div class="icon-text">Icon 6</div>
                        </div>
                    </div>
                </div>

                <!-- Text With Icon Engraving (hidden by default) -->
                <div id="textWithIcon-options" class="engraving-type-options" style="display: none;">
                    <p>Select icons and enter text for each position (max 7 characters):</p>
                    <div class="icon-with-text-grid">
                        <div class="icon-with-text-option" data-position="1">
                            <div class="icon-plus">+</div>
                            <input type="text" class="icon-with-text-input" placeholder="Text 1" maxlength="7">
                        </div>
                        <div class="icon-with-text-option" data-position="2">
                            <div class="icon-plus">+</div>
                            <input type="text" class="icon-with-text-input" placeholder="Text 2" maxlength="7">
                        </div>
                        <div class="icon-with-text-option" data-position="3">
                            <div class="icon-plus">+</div>
                            <input type="text" class="icon-with-text-input" placeholder="Text 3" maxlength="7">
                        </div>
                        <div class="icon-with-text-option" data-position="4">
                            <div class="icon-plus">+</div>
                            <input type="text" class="icon-with-text-input" placeholder="Text 4" maxlength="7">
                        </div>
                        <div class="icon-with-text-option" data-position="5">
                            <div class="icon-plus">+</div>
                            <input type="text" class="icon-with-text-input" placeholder="Text 5" maxlength="7">
                        </div>
                        <div class="icon-with-text-option" data-position="6">
                            <div class="icon-plus">+</div>
                            <input type="text" class="icon-with-text-input" placeholder="Text 6" maxlength="7">
                        </div>
                    </div>
                </div>
            </div>

            <div class="save-btn-container">
                <button class="save-btn" id="save-config">Save Configuration</button>
            </div>
        </div>
    </main>

    <!-- Icon Selection Modal -->
    <div class="modal" id="iconModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Select an Icon</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="icon-grid-modal" id="iconGridModal">
                <!-- Icons will be dynamically generated here -->
            </div>
        </div>
    </div>
    <div class="cancel-btn-container" style="margin-top: 1rem; display: none;" id="cancelEditContainer">
        <button class="cancel-edit-btn" id="cancelEditBtn"
            style="background-color: #6b7280; color: white; padding: 0.5rem 1rem; border: none; border-radius: 4px; cursor: pointer;">
            Cancel Edit
        </button>
    </div>
    <footer>
        <div class="footer-content">
            <div class="logo">
                <div class="logo-icon">L</div>
                <span>Lumi Configurator</span>
            </div>
            <div class="copyright">
                &copy; 2023 Lumi Configurator. All rights reserved.
            </div>
        </div>
    </footer>
<!-- Switch Label Modal -->
<div class="modal" id="switchLabelModal">
    <div class="modal-content" style="max-width: 500px; height: auto;">
        <div class="modal-header">
            <h2 class="modal-title">Save Design</h2>
            <button class="close-modal" onclick="closeSwitchLabelModal()">&times;</button>
        </div>
        <div class="modal-body" style="padding: 20px;">
            <div style="margin-bottom: 20px;">
                <label for="switchLabelInput" style="display: block; margin-bottom: 8px; font-weight: 500;">
                    Enter a name/label for this switch design:
                </label>
                <input 
                    type="text" 
                    id="switchLabelInput" 
                    placeholder="e.g., Living Room Switch, Office Switch, etc."
                    maxlength="30"
                    style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 14px;"
                >
                <div style="text-align: right; margin-top: 4px; color: #64748b; font-size: 12px;">
                    <span id="charCount">0</span>/30 characters
                </div>
            </div>
            
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 24px;">
                <button 
                    onclick="closeSwitchLabelModal()" 
                    style="padding: 10px 20px; background: #e2e8f0; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;"
                >
                    Cancel
                </button>
                <button 
                    onclick="confirmSaveDesign()" 
                    style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;"
                >
                    Save Design
                </button>
            </div>
        </div>
    </div>
</div>
    <script>
        // Current selected position for icon modal
        let currentIconPosition = null;
        let currentIconType = null; // 'icon' or 'textWithIcon'

        // Color selection
        const colorOptions = document.querySelectorAll('.color-option');
        const boxes = document.querySelectorAll('.box');

        colorOptions.forEach(option => {
            option.addEventListener('click', () => {
                // Remove selected class from all options
                colorOptions.forEach(opt => opt.classList.remove('selected'));
                // Add selected class to clicked option
                option.classList.add('selected');

                // Get the selected color
                const selectedColor = option.getAttribute('data-color');

                // Update box backgrounds
                boxes.forEach(box => {
                    box.style.backgroundColor = selectedColor;
                });
            });
        });

        // Engraving type selection
        const engravingOptions = document.querySelectorAll('.engraving-option');
        const engravingTypeOptions = document.querySelectorAll('.engraving-type-options');

        engravingOptions.forEach(option => {
            option.addEventListener('click', () => {
                // Remove selected class from all options
                engravingOptions.forEach(opt => opt.classList.remove('selected'));
                // Add selected class to clicked option
                option.classList.add('selected');

                // Get the selected type
                const selectedType = option.getAttribute('data-type');

                // Hide all options
                engravingTypeOptions.forEach(opt => {
                    opt.style.display = 'none';
                });

                // Show selected options
                document.getElementById(`${selectedType}-options`).style.display = 'block';

                // Update preview based on selected type
                updatePreview(selectedType);
            });
        });

        // Text input handling
        const textInputs = document.querySelectorAll('.text-input');
        textInputs.forEach(input => {
            input.addEventListener('input', () => {
                // Enforce character limit
                if (input.value.length > 7) {
                    input.value = input.value.substring(0, 7);
                }
                updateTextPreview();
            });
        });

        // Icon selection handling
        const iconOptions = document.querySelectorAll('.icon-option');
        iconOptions.forEach(option => {
            option.addEventListener('click', () => {
                currentIconPosition = option.getAttribute('data-position');
                currentIconType = 'icon';
                openIconModal();
            });
        });

        // Icon with text input handling
        const iconWithTextInputs = document.querySelectorAll('.icon-with-text-input');
        iconWithTextInputs.forEach(input => {
            input.addEventListener('input', () => {
                // Enforce character limit
                if (input.value.length > 7) {
                    input.value = input.value.substring(0, 7);
                }
                updateIconWithTextPreview();
            });
        });

        // Icon with text option click handling
        const iconWithTextOptions = document.querySelectorAll('.icon-with-text-option');
        iconWithTextOptions.forEach(option => {
            option.addEventListener('click', (e) => {
                // Only open modal if the plus icon was clicked, not the input
                if (e.target.classList.contains('icon-plus') || e.target.classList.contains('icon-with-text-option')) {
                    currentIconPosition = option.getAttribute('data-position');
                    currentIconType = 'textWithIcon';
                    openIconModal();
                }
            });
        });

        // Save configuration button
        const saveBtn = document.getElementById('save-config');
        saveBtn.addEventListener('click', () => {
            // Get current configuration
            const selectedColor = document.querySelector('.color-option.selected').getAttribute('data-color');
            const selectedColorName = document.querySelector('.color-option.selected').getAttribute('data-name');
            const selectedEngravingType = document.querySelector('.engraving-option.selected').getAttribute('data-type');

            // Get the preview HTML
            const square = document.querySelector('.square');
            const previewHTML = square.innerHTML;

            // Get text values for all 6 positions
            const textValues = getTextValues();

            // Create design object
            const design = {
                id: Date.now().toString(),
                color: selectedColor,
                colorName: selectedColorName,
                engravingType: selectedEngravingType,
                previewHTML: previewHTML,
                fileName: new Date().toLocaleString(),
                timestamp: new Date().toISOString(),
                textValues: textValues
            };

            // Get existing designs from localStorage
            let designs = JSON.parse(localStorage.getItem('lumiDesigns') || '[]');

            // Add new design
            designs.push(design);

            // Save back to localStorage
            localStorage.setItem('lumiDesigns', JSON.stringify(designs));

            alert('Design saved successfully!');

            // Optionally redirect to designs page
            // window.location.href = 'designs.html';
        });

        // Modal functionality
        const modal = document.getElementById('iconModal');
        const closeModal = document.querySelector('.close-modal');
        const iconGridModal = document.getElementById('iconGridModal');

        // Generate 87 icon options in the modal
        function generateIcons() {
            for (let i = 1; i <= 87; i++) {
                const iconOption = document.createElement('div');
                iconOption.className = 'icon-modal-option';
                iconOption.setAttribute('data-icon', i);

                // Create image element for the icon
                const iconImg = document.createElement('img');
                iconImg.className = 'icon-preview';
                iconImg.alt = `Icon ${i}`;

                // Use local icon paths
                iconImg.src = `./icons/${i}.png`;

                // Add loading state
                iconImg.onload = () => {
                    iconImg.classList.remove('loading');
                };

                iconImg.onerror = () => {
                    // If icon fails to load, show a placeholder
                    iconImg.src = `data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIHZpZXdCb3g9IjAgMCA0OCA0OCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQ4IiBoZWlnaHQ9IjQ4IiBmaWxsPSIjM0I4MkY2Ii8+Cjx0ZXh0IHg9IjI0IiB5PSIyOCIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+${i}</dGV4dD4KPC9zdmc+`;
                };

                const iconNumber = document.createElement('div');
                iconNumber.className = 'icon-number';
                iconNumber.textContent = `Icon ${i}`;

                iconOption.appendChild(iconImg);
                iconOption.appendChild(iconNumber);

                iconOption.addEventListener('click', () => {
                    selectIcon(i);
                });

                iconGridModal.appendChild(iconOption);
            }
        }

        // Initialize icons
        generateIcons();

        // Open modal function
        function openIconModal() {
            modal.style.display = 'flex';
        }

        // Close modal function
        function closeModalFunc() {
            modal.style.display = 'none';
        }

        // Close modal when clicking the X or outside the modal
        closeModal.addEventListener('click', closeModalFunc);
        window.addEventListener('click', (e) => {
            if (e.target === modal) {
                closeModalFunc();
            }
        });

        // Select icon function
        function selectIcon(iconNumber) {
            if (currentIconPosition && currentIconType) {
                if (currentIconType === 'icon') {
                    // Update the icon option display
                    const iconOption = document.querySelector(`.icon-option[data-position="${currentIconPosition}"]`);
                    const iconPlus = iconOption.querySelector('.icon-plus');

                    // Replace the plus with the selected icon
                    iconPlus.style.display = 'none';

                    // Create or update the icon image
                    let iconImg = iconOption.querySelector('.icon-preview');
                    if (!iconImg) {
                        iconImg = document.createElement('img');
                        iconImg.className = 'icon-preview';
                        iconOption.insertBefore(iconImg, iconOption.querySelector('.icon-text'));
                    }

                    // Set the actual icon image source
                    iconImg.src = `./icons/${iconNumber}.png`;
                    iconImg.alt = `Icon ${iconNumber}`;
                    iconImg.style.width = '32px'; // Larger preview size
                    iconImg.style.height = '32px'; // Larger preview size

                    // Mark as selected
                    iconOption.classList.add('selected');

                    // Update preview
                    updateIconPreview();
                } else if (currentIconType === 'textWithIcon') {
                    // Update the icon with text option display
                    const iconOption = document.querySelector(`.icon-with-text-option[data-position="${currentIconPosition}"]`);
                    const iconPlus = iconOption.querySelector('.icon-plus');

                    // Replace the plus with the selected icon
                    iconPlus.style.display = 'none';

                    // Create or update the icon image
                    let iconImg = iconOption.querySelector('.icon-preview');
                    if (!iconImg) {
                        iconImg = document.createElement('img');
                        iconImg.className = 'icon-preview';
                        iconOption.insertBefore(iconImg, iconOption.querySelector('.icon-with-text-input'));
                    }

                    // Set the actual icon image source
                    iconImg.src = `./icons/${iconNumber}.png`;
                    iconImg.alt = `Icon ${iconNumber}`;
                    iconImg.style.width = '32px'; // Larger preview size
                    iconImg.style.height = '32px'; // Larger preview size

                    // Mark as selected
                    iconOption.classList.add('selected');

                    // Update preview
                    updateIconWithTextPreview();
                }
            }

            closeModalFunc();
        }

        // Function to update preview based on engraving type
        function updatePreview(type) {
            // Reset all boxes
            boxes.forEach(box => {
                const top = box.querySelector('.box-top');
                const content = box.querySelector('.box-content');
                const bottom = box.querySelector('.box-bottom');

                top.innerHTML = '';
                content.innerHTML = '';
                bottom.innerHTML = '';

                // Apply normal engraving (dashes) by default
                if (type === 'normal') {
                    top.innerHTML = '—';
                    bottom.innerHTML = '—';
                }
            });

            // Update based on specific type
            if (type === 'text') {
                updateTextPreview();
            } else if (type === 'icon') {
                updateIconPreview();
            } else if (type === 'textWithIcon') {
                updateIconWithTextPreview();
            }
        }

        // Function to update text preview
        function updateTextPreview() {
            const textInputs = document.querySelectorAll('.text-input');
            const boxes = document.querySelectorAll('.box');

            boxes.forEach((box, index) => {
                const top = box.querySelector('.box-top');
                const content = box.querySelector('.box-content');
                const bottom = box.querySelector('.box-bottom');

                // For text engraving, show text at top and bottom
                if (index === 0) {
                    top.textContent = textInputs[0].value || 'Text 1';
                    bottom.textContent = textInputs[3].value || 'Text 4';
                } else if (index === 1) {
                    top.textContent = textInputs[1].value || 'Text 2';
                    bottom.textContent = textInputs[4].value || 'Text 5';
                } else if (index === 2) {
                    top.textContent = textInputs[2].value || 'Text 3';
                    bottom.textContent = textInputs[5].value || 'Text 6';
                }
            });
        }

// Function to update icon preview (modify if needed)
function updateIconPreview() {
    const iconOptions = document.querySelectorAll('.icon-option');
    const boxes = document.querySelectorAll('.box');

    boxes.forEach((box, index) => {
        const top = box.querySelector('.box-top');
        const content = box.querySelector('.box-content');
        const bottom = box.querySelector('.box-bottom');

        // For icon engraving, show icons at top and bottom
        if (index === 0) {
            const iconOption1 = iconOptions[0];
            const iconOption4 = iconOptions[3];
            
            const iconNumber1 = getIconNumberFromElement(iconOption1);
            const iconNumber4 = getIconNumberFromElement(iconOption4);
            
            top.innerHTML = iconNumber1 ? `<img src="./icons/${iconNumber1}.png" alt="Icon" style="width: 40px; height: 40px;">` : '';
            bottom.innerHTML = iconNumber4 ? `<img src="./icons/${iconNumber4}.png" alt="Icon" style="width: 40px; height: 40px;">` : '';
        } else if (index === 1) {
            const iconOption2 = iconOptions[1];
            const iconOption5 = iconOptions[4];
            
            const iconNumber2 = getIconNumberFromElement(iconOption2);
            const iconNumber5 = getIconNumberFromElement(iconOption5);
            
            top.innerHTML = iconNumber2 ? `<img src="./icons/${iconNumber2}.png" alt="Icon" style="width: 40px; height: 40px;">` : '';
            bottom.innerHTML = iconNumber5 ? `<img src="./icons/${iconNumber5}.png" alt="Icon" style="width: 40px; height: 40px;">` : '';
        } else if (index === 2) {
            const iconOption3 = iconOptions[2];
            const iconOption6 = iconOptions[5];
            
            const iconNumber3 = getIconNumberFromElement(iconOption3);
            const iconNumber6 = getIconNumberFromElement(iconOption6);
            
            top.innerHTML = iconNumber3 ? `<img src="./icons/${iconNumber3}.png" alt="Icon" style="width: 40px; height: 40px;">` : '';
            bottom.innerHTML = iconNumber6 ? `<img src="./icons/${iconNumber6}.png" alt="Icon" style="width: 40px; height: 40px;">` : '';
        }
    });
}
        // Function to update icon with text preview
        // Function to update icon with text preview
        function updateIconWithTextPreview() {
            const iconWithTextOptions = document.querySelectorAll('.icon-with-text-option');
            const boxes = document.querySelectorAll('.box');

            boxes.forEach((box, index) => {
                const top = box.querySelector('.box-top');
                const content = box.querySelector('.box-content');
                const bottom = box.querySelector('.box-bottom');

                // For icon with text engraving
                if (index === 0) {
                    const input1 = iconWithTextOptions[0].querySelector('.icon-with-text-input');
                    const input4 = iconWithTextOptions[3].querySelector('.icon-with-text-input');
                    const icon1 = iconWithTextOptions[0].querySelector('.icon-preview');
                    const icon4 = iconWithTextOptions[3].querySelector('.icon-preview');

                    // Position 1: Icon above, text below (default)
                    top.innerHTML = (icon1 ? `<div><img src="${icon1.src}" alt="Icon" style="width: 35px; height: 35px;"></div>` : '') +
                        `<div>${input1.value || 'Text 1'}</div>`;

                    // Position 4: Text above, icon below
                    bottom.innerHTML = `<div>${input4.value || 'Text 4'}</div>` +
                        (icon4 ? `<div><img src="${icon4.src}" alt="Icon" style="width: 35px; height: 35px; margin-top: 5px;"></div>` : '');
                } else if (index === 1) {
                    const input2 = iconWithTextOptions[1].querySelector('.icon-with-text-input');
                    const input5 = iconWithTextOptions[4].querySelector('.icon-with-text-input');
                    const icon2 = iconWithTextOptions[1].querySelector('.icon-preview');
                    const icon5 = iconWithTextOptions[4].querySelector('.icon-preview');

                    // Position 2: Icon above, text below (default)
                    top.innerHTML = (icon2 ? `<div><img src="${icon2.src}" alt="Icon" style="width: 35px; height: 35px;"></div>` : '') +
                        `<div>${input2.value || 'Text 2'}</div>`;

                    // Position 5: Text above, icon below
                    bottom.innerHTML = `<div>${input5.value || 'Text 5'}</div>` +
                        (icon5 ? `<div><img src="${icon5.src}" alt="Icon" style="width: 35px; height: 35px; margin-top: 5px;"></div>` : '');
                } else if (index === 2) {
                    const input3 = iconWithTextOptions[2].querySelector('.icon-with-text-input');
                    const input6 = iconWithTextOptions[5].querySelector('.icon-with-text-input');
                    const icon3 = iconWithTextOptions[2].querySelector('.icon-preview');
                    const icon6 = iconWithTextOptions[5].querySelector('.icon-preview');

                    // Position 3: Icon above, text below (default)
                    top.innerHTML = (icon3 ? `<div><img src="${icon3.src}" alt="Icon" style="width: 35px; height: 35px;"></div>` : '') +
                        `<div>${input3.value || 'Text 3'}</div>`;

                    // Position 6: Text above, icon below
                    bottom.innerHTML = `<div>${input6.value || 'Text 6'}</div>` +
                        (icon6 ? `<div><img src="${icon6.src}" alt="Icon" style="width: 35px; height: 35px; margin-top: 5px;"></div>` : '');
                }
            });
        }
        // Function to get all text values
        function getTextValues() {
            const textValues = {
                text1: '',
                text2: '',
                text3: '',
                text4: '',
                text5: '',
                text6: ''
            };

            // Get values from text inputs
            const textInputs = document.querySelectorAll('.text-input');
            if (textInputs.length > 0) {
                textValues.text1 = textInputs[0].value || '';
                textValues.text2 = textInputs[1].value || '';
                textValues.text3 = textInputs[2].value || '';
                textValues.text4 = textInputs[3].value || '';
                textValues.text5 = textInputs[4].value || '';
                textValues.text6 = textInputs[5].value || '';
            }

            // Get values from icon with text inputs
            const iconWithTextInputs = document.querySelectorAll('.icon-with-text-input');
            if (iconWithTextInputs.length > 0) {
                textValues.text1 = iconWithTextInputs[0].value || '';
                textValues.text2 = iconWithTextInputs[1].value || '';
                textValues.text3 = iconWithTextInputs[2].value || '';
                textValues.text4 = iconWithTextInputs[3].value || '';
                textValues.text5 = iconWithTextInputs[4].value || '';
                textValues.text6 = iconWithTextInputs[5].value || '';
            }

            return textValues;
        }

        // Initialize with normal engraving
        updatePreview('normal');
    </script>
    <script>
        // Block page if not logged in
        const isLoggedIn = sessionStorage.getItem('lumi_authenticated');

        if (!isLoggedIn) {
            window.location.href = 'login.html';
        }

// Helper function to better extract icon positions from preview
function analyzePreviewStructure(html) {
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    
    const analysis = {
        boxes: [],
        type: 'unknown'
    };
    
    // Analyze each box
    for (let i = 1; i <= 3; i++) {
        const box = doc.getElementById(`box${i}`);
        if (box) {
            const boxAnalysis = {
                id: `box${i}`,
                top: { type: 'empty', content: '' },
                bottom: { type: 'empty', content: '' }
            };
            
            const top = box.querySelector('.box-top');
            const bottom = box.querySelector('.box-bottom');
            
            if (top) {
                const img = top.querySelector('img');
                if (img) {
                    boxAnalysis.top.type = 'icon';
                    boxAnalysis.top.content = img.src;
                    boxAnalysis.top.text = top.textContent.replace(img.outerHTML, '').trim();
                } else {
                    boxAnalysis.top.type = 'text';
                    boxAnalysis.top.content = top.textContent.trim();
                }
            }
            
            if (bottom) {
                const img = bottom.querySelector('img');
                if (img) {
                    boxAnalysis.bottom.type = 'icon';
                    boxAnalysis.bottom.content = img.src;
                    boxAnalysis.bottom.text = bottom.textContent.replace(img.outerHTML, '').trim();
                } else {
                    boxAnalysis.bottom.type = 'text';
                    boxAnalysis.bottom.content = bottom.textContent.trim();
                }
            }
            
            analysis.boxes.push(boxAnalysis);
        }
    }
    
    // Determine type based on analysis
    const hasIcons = analysis.boxes.some(box => box.top.type === 'icon' || box.bottom.type === 'icon');
    const hasText = analysis.boxes.some(box => 
        (box.top.type === 'text' && box.top.content) || 
        (box.bottom.type === 'text' && box.bottom.content)
    );
    
    if (hasIcons && hasText) {
        analysis.type = 'textWithIcon';
    } else if (hasIcons) {
        analysis.type = 'icon';
    } else if (hasText) {
        analysis.type = 'text';
    } else {
        analysis.type = 'normal';
    }
    
    return analysis;
}

// ========== EDIT MODE FUNCTIONALITY ==========
document.addEventListener('DOMContentLoaded', function() {
    // Check if we're in edit mode
    const isEditing = sessionStorage.getItem('isEditing') === 'true';
    const editDesignDataStr = sessionStorage.getItem('editDesignData');
    
    if (isEditing && editDesignDataStr) {
        try {
            const design = JSON.parse(editDesignDataStr);
            console.log('Edit mode activated for design:', design);
            
            // Update page title
            const titleElement = document.querySelector('.title');
            if (titleElement) {
                titleElement.innerHTML = 'Edit Design <span style="font-size: 14px; color: #3b82f6;">(Editing: ' + design.fileName + ')</span>';
            }
            
            // Function to extract icons and text from preview HTML
            function extractDesignDataFromPreview(html) {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                const data = {
                    icons: {},
                    texts: {},
                    type: 'normal'
                };
                
                // Extract all image sources with their positions
                for (let i = 1; i <= 3; i++) {
                    const topBox = doc.querySelector(`#box${i}-top`);
                    const bottomBox = doc.querySelector(`#box${i}-bottom`);
                    
                    // Check top box
                    if (topBox) {
                        const img = topBox.querySelector('img');
                        if (img && img.src) {
                            data.icons[`top${i}`] = img.src;
                            // Check if there's also text
                            const textContent = topBox.textContent.trim();
                            if (textContent && !textContent.includes('—')) {
                                data.texts[`text${i}`] = textContent;
                            }
                        } else {
                            const text = topBox.textContent.trim();
                            if (text && text !== '—') {
                                data.texts[`text${i}`] = text;
                            }
                        }
                    }
                    
                    // Check bottom box
                    if (bottomBox) {
                        const img = bottomBox.querySelector('img');
                        if (img && img.src) {
                            data.icons[`bottom${i}`] = img.src;
                            // Check if there's also text
                            const textContent = bottomBox.textContent.trim();
                            if (textContent && !textContent.includes('—')) {
                                data.texts[`text${i + 3}`] = textContent;
                            }
                        } else {
                            const text = bottomBox.textContent.trim();
                            if (text && text !== '—') {
                                data.texts[`text${i + 3}`] = text;
                            }
                        }
                    }
                }
                
                // Determine type
                const hasIcons = Object.keys(data.icons).length > 0;
                const hasText = Object.keys(data.texts).length > 0;
                
                if (hasIcons && hasText) {
                    data.type = 'textWithIcon';
                } else if (hasIcons) {
                    data.type = 'icon';
                } else if (hasText) {
                    data.type = 'text';
                } else {
                    data.type = 'normal';
                }
                
                return data;
            }
            
            // Extract data from saved design
            const extractedData = extractDesignDataFromPreview(design.previewHTML);
            console.log('Extracted design data:', extractedData);
            
            // Store for later use
            window.editDesignData = extractedData;
            
            // 1. Apply saved color
            setTimeout(() => {
                const colorOptions = document.querySelectorAll('.color-option');
                colorOptions.forEach(option => {
                    const colorValue = option.getAttribute('data-color');
                    const colorName = option.getAttribute('data-name');
                    
                    if (colorValue === design.color || colorName === design.colorName) {
                        option.click();
                    }
                });
            }, 100);
            
            // 2. Apply engraving type and populate data
            setTimeout(() => {
                const engravingOptions = document.querySelectorAll('.engraving-option');
                let typeApplied = false;
                
                engravingOptions.forEach(option => {
                    const type = option.getAttribute('data-type');
                    if (type === extractedData.type || type === design.engravingType) {
                        option.click();
                        typeApplied = true;
                        
                        // Populate data based on type
                        setTimeout(() => {
                            if (type === 'text') {
                                populateTextData(extractedData.texts);
                            } else if (type === 'icon') {
                                populateIconData(extractedData.icons);
                            } else if (type === 'textWithIcon') {
                                populateTextWithIconData(extractedData.icons, extractedData.texts);
                            }
                        }, 500); // Increased delay to ensure UI is ready
                    }
                });
                
                if (!typeApplied) {
                    // Default to normal if type not found
                    document.querySelector('.engraving-option[data-type="normal"]').click();
                }
            }, 300);
            
            // Function to populate text data
            function populateTextData(texts) {
                console.log('Populating text data:', texts);
                
                const textInputs = document.querySelectorAll('.text-input');
                if (textInputs.length >= 6) {
                    textInputs[0].value = texts.text1 || '';
                    textInputs[1].value = texts.text2 || '';
                    textInputs[2].value = texts.text3 || '';
                    textInputs[3].value = texts.text4 || '';
                    textInputs[4].value = texts.text5 || '';
                    textInputs[5].value = texts.text6 || '';
                    
                    // Update preview
                    setTimeout(() => updateTextPreview(), 100);
                }
            }
            
            // Function to populate icon data
            function populateIconData(icons) {
                console.log('Populating icon data:', icons);
                
                // Map icon positions to UI positions
                const positionMap = {
                    'top1': 1, 'top2': 2, 'top3': 3,
                    'bottom1': 4, 'bottom2': 5, 'bottom3': 6
                };
                
                // Process each icon
                Object.keys(icons).forEach(key => {
                    const uiPosition = positionMap[key];
                    const iconSrc = icons[key];
                    
                    if (uiPosition && iconSrc) {
                        // Extract icon number from src
                        const match = iconSrc.match(/\/(\d+)\.png$/);
                        if (match && match[1]) {
                            const iconNumber = parseInt(match[1]);
                            console.log(`Setting icon ${iconNumber} at position ${uiPosition}`);
                            
                            // Select the icon in the UI
                            selectIconForPosition(iconNumber, uiPosition, 'icon');
                        }
                    }
                });
                
                // Update preview after all icons are set
                setTimeout(() => updateIconPreview(), 300);
            }
            
            // Function to populate text with icon data
            function populateTextWithIconData(icons, texts) {
                console.log('Populating text with icon data:', icons, texts);
                
                // Populate text inputs
                const textInputs = document.querySelectorAll('.icon-with-text-input');
                if (textInputs.length >= 6) {
                    textInputs[0].value = texts.text1 || '';
                    textInputs[1].value = texts.text2 || '';
                    textInputs[2].value = texts.text3 || '';
                    textInputs[3].value = texts.text4 || '';
                    textInputs[4].value = texts.text5 || '';
                    textInputs[5].value = texts.text6 || '';
                }
                
                // Map icon positions to UI positions
                const positionMap = {
                    'top1': 1, 'top2': 2, 'top3': 3,
                    'bottom1': 4, 'bottom2': 5, 'bottom3': 6
                };
                
                // Process each icon
                Object.keys(icons).forEach(key => {
                    const uiPosition = positionMap[key];
                    const iconSrc = icons[key];
                    
                    if (uiPosition && iconSrc) {
                        // Extract icon number from src
                        const match = iconSrc.match(/\/(\d+)\.png$/);
                        if (match && match[1]) {
                            const iconNumber = parseInt(match[1]);
                            console.log(`Setting icon ${iconNumber} at position ${uiPosition} with text`);
                            
                            // Select the icon in the UI
                            selectIconForPosition(iconNumber, uiPosition, 'textWithIcon');
                        }
                    }
                });
                
                // Update preview
                setTimeout(() => updateIconWithTextPreview(), 300);
            }
            
            // Function to select icon for a specific position
            function selectIconForPosition(iconNumber, position, type) {
                // Find the icon option element
                let option;
                if (type === 'icon') {
                    option = document.querySelector(`.icon-option[data-position="${position}"]`);
                } else if (type === 'textWithIcon') {
                    option = document.querySelector(`.icon-with-text-option[data-position="${position}"]`);
                }
                
                if (!option) {
                    console.error(`Could not find option for position ${position}, type ${type}`);
                    return;
                }
                
                // Hide the plus icon
                const iconPlus = option.querySelector('.icon-plus');
                if (iconPlus) {
                    iconPlus.style.display = 'none';
                }
                
                // Create or update the icon image
                let iconImg = option.querySelector('.icon-preview');
                if (!iconImg) {
                    iconImg = document.createElement('img');
                    iconImg.className = 'icon-preview';
                    
                    // Insert in correct place based on type
                    if (type === 'icon') {
                        const iconText = option.querySelector('.icon-text');
                        if (iconText) {
                            option.insertBefore(iconImg, iconText);
                        } else {
                            option.appendChild(iconImg);
                        }
                    } else if (type === 'textWithIcon') {
                        const textInput = option.querySelector('.icon-with-text-input');
                        if (textInput) {
                            option.insertBefore(iconImg, textInput);
                        } else {
                            option.appendChild(iconImg);
                        }
                    }
                }
                
                // Set the icon image
                iconImg.src = `./icons/${iconNumber}.png`;
                iconImg.alt = `Icon ${iconNumber}`;
                iconImg.style.width = '32px';
                iconImg.style.height = '32px';
                
                // Mark as selected
                option.classList.add('selected');
                
                // Store icon number for reference
                option.setAttribute('data-icon-number', iconNumber);
                
                console.log(`Icon ${iconNumber} set at position ${position}`);
            }
            
            // 3. Modify save button for edit mode
            modifySaveButtonForEditMode(design.id);
            
            // 4. Add cancel button
            addCancelEditButton();
            
        } catch (error) {
            console.error('Error loading edit data:', error);
        }
    }
    
    // Function to modify save button for edit mode
    function modifySaveButtonForEditMode(designId) {
        const saveBtn = document.getElementById('save-config');
        if (!saveBtn) return;
        
        // Change button appearance
        saveBtn.textContent = 'Update Design';
        saveBtn.style.backgroundColor = '#3b82f6';
        
        // Remove existing event listeners by cloning
        const newSaveBtn = saveBtn.cloneNode(true);
        saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
        
        // Add new event handler
        newSaveBtn.addEventListener('click', function handleEditSave(e) {
            e.preventDefault();
            
            // Get current configuration
            const selectedColor = document.querySelector('.color-option.selected').getAttribute('data-color');
            const selectedColorName = document.querySelector('.color-option.selected').getAttribute('data-name');
            const selectedEngravingType = document.querySelector('.engraving-option.selected').getAttribute('data-type');
            
            // Get the preview HTML
            const square = document.querySelector('.square');
            const previewHTML = square.innerHTML;
            
            // Get text values
            const textValues = getTextValues();
            
            // Update design
            const updatedDesign = {
                id: designId,
                color: selectedColor,
                colorName: selectedColorName,
                engravingType: selectedEngravingType,
                previewHTML: previewHTML,
                fileName: new Date().toLocaleString(),
                timestamp: new Date().toISOString(),
                textValues: textValues
            };
            
            // Save to localStorage
            let designs = JSON.parse(localStorage.getItem('lumiDesigns') || '[]');
            const index = designs.findIndex(d => d.id === designId);
            
            if (index !== -1) {
                designs[index] = updatedDesign;
                localStorage.setItem('lumiDesigns', JSON.stringify(designs));
                
                // Clear edit mode
                sessionStorage.removeItem('editDesignData');
                sessionStorage.removeItem('isEditing');
                sessionStorage.removeItem('editDesignId');
                
                alert('Design updated successfully!');
                window.location.href = 'designs.html';
            } else {
                alert('Design not found! Creating new design instead.');
                
                // Create new design
                updatedDesign.id = Date.now().toString();
                designs.push(updatedDesign);
                localStorage.setItem('lumiDesigns', JSON.stringify(designs));
                
                sessionStorage.clear();
                window.location.href = 'designs.html';
            }
        });
    }
    
    // Function to add cancel edit button
// Function to add cancel edit button
function addCancelEditButton() {
    if (sessionStorage.getItem('isEditing') !== 'true') return;
    
    // Create cancel button
    const cancelBtn = document.createElement('button');
    cancelBtn.id = 'cancelEditBtn';
    cancelBtn.textContent = 'Cancel Edit';
    cancelBtn.style.cssText = `
        background-color: #6b7280;
        color: white;
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-left: 10px;
    `;
    
    cancelBtn.addEventListener('click', () => {
        if (confirm('Cancel editing? All unsaved changes will be lost.')) {
            // Only remove edit-related sessionStorage items
            sessionStorage.removeItem('editDesignData');
            sessionStorage.removeItem('isEditing');
            sessionStorage.removeItem('editDesignId');
            
            // Redirect to configurator page (not designs.html)
            window.location.href = 'index.html';
        }
    });
    
    // Add to page
    const saveBtnContainer = document.querySelector('.save-btn-container');
    if (saveBtnContainer) {
        saveBtnContainer.appendChild(cancelBtn);
    }
}
});


// Cancel edit functionality
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const cancelEditContainer = document.getElementById('cancelEditContainer');

        if (cancelEditBtn) {
            cancelEditBtn.addEventListener('click', () => {
                if (confirm('Cancel editing? All unsaved changes will be lost.')) {
                    // Clear edit mode data
                    sessionStorage.removeItem('editDesignData');
                    sessionStorage.removeItem('isEditing');
                    sessionStorage.removeItem('editDesignId');

                    // Reload page to reset
                    window.location.href = 'index.html';
                }
            });
        }

        // Show cancel button only in edit mode
        if (sessionStorage.getItem('isEditing') === 'true') {
            if (cancelEditContainer) {
                cancelEditContainer.style.display = 'block';
            }
        }


        // Helper function to extract icon number from icon selection
function getIconNumberFromElement(element) {
    if (!element) return null;
    
    // Check data-icon-number attribute first
    const iconNumber = element.getAttribute('data-icon-number');
    if (iconNumber) return parseInt(iconNumber);
    
    // Check img src
    const img = element.querySelector('img');
    if (img && img.src) {
        const match = img.src.match(/\/(\d+)\.png$/);
        if (match && match[1]) {
            return parseInt(match[1]);
        }
    }
    
    return null;
}


// ========== SWITCH LABEL MODAL FUNCTIONS ==========

// Open switch label modal
function openSwitchLabelModal() {
    const modal = document.getElementById('switchLabelModal');
    const input = document.getElementById('switchLabelInput');
    const charCount = document.getElementById('charCount');
    
    // Reset input
    input.value = '';
    charCount.textContent = '0';
    
    // Focus on input
    modal.style.display = 'flex';
    setTimeout(() => input.focus(), 100);
}

// Close switch label modal
function closeSwitchLabelModal() {
    document.getElementById('switchLabelModal').style.display = 'none';
}

// Character counter for input
document.addEventListener('DOMContentLoaded', function() {
    const switchLabelInput = document.getElementById('switchLabelInput');
    if (switchLabelInput) {
        switchLabelInput.addEventListener('input', function() {
            const charCount = document.getElementById('charCount');
            charCount.textContent = this.value.length;
        });
        
        // Allow Enter key to save
        switchLabelInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                confirmSaveDesign();
            }
        });
    }
});

// Confirm save design
function confirmSaveDesign() {
    const switchLabel = document.getElementById('switchLabelInput').value.trim();
    
    if (!switchLabel) {
        alert('Please enter a name/label for this design.');
        return;
    }
    
    if (switchLabel.length > 30) {
        alert('Label must be 30 characters or less.');
        return;
    }
    
    // Update the preview with the switch label
    updatePreviewWithSwitchLabel(switchLabel);
    
    // Save the design
    saveDesignWithLabel(switchLabel);
    
    // Close modal
    closeSwitchLabelModal();
}

// Function to update preview with switch label
function updatePreviewWithSwitchLabel(switchLabel) {
    const summaryPreview = document.querySelector('.summary-preview');
    if (!summaryPreview) return;
    
    // Find or create the switch label display
    let labelDisplay = document.querySelector('.switch-label-display');
    
    if (!labelDisplay) {
        // Create label display
        labelDisplay = document.createElement('div');
        labelDisplay.className = 'switch-label-display';
        labelDisplay.style.cssText = `
            margin-top: 15px;
            padding: 10px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            text-align: center;
        `;
        
        // Add to summary preview
        summaryPreview.appendChild(labelDisplay);
    }
    
    // Update label display content
    labelDisplay.innerHTML = `
        <div style="font-weight: 600; color: #1e293b; margin-bottom: 5px;">Switch Label:</div>
        <div style="font-size: 18px; color: #3b82f6; font-weight: 500;">${switchLabel}</div>
    `;
}

// Function to save design with label
function saveDesignWithLabel(switchLabel) {
    // Get current configuration
    const selectedColor = document.querySelector('.color-option.selected').getAttribute('data-color');
    const selectedColorName = document.querySelector('.color-option.selected').getAttribute('data-name');
    const selectedEngravingType = document.querySelector('.engraving-option.selected').getAttribute('data-type');
    
    // Get the preview HTML
    const square = document.querySelector('.square');
    const previewHTML = square.innerHTML;
    
    // Get text values for all 6 positions
    const textValues = getTextValues();
    
    // Create design object with switch label
    const design = {
        id: Date.now().toString(),
        color: selectedColor,
        colorName: selectedColorName,
        engravingType: selectedEngravingType,
        previewHTML: previewHTML,
        fileName: new Date().toLocaleString(),
        switchLabel: switchLabel, // Add the switch label
        timestamp: new Date().toISOString(),
        textValues: textValues
    };
    
    // Get existing designs from localStorage
    let designs = JSON.parse(localStorage.getItem('lumiDesigns') || '[]');
    
    // Add new design
    designs.push(design);
    
    // Save back to localStorage
    localStorage.setItem('lumiDesigns', JSON.stringify(designs));
    
    // Show success message
    alert(`Design saved successfully with label: "${switchLabel}"`);
    
    // Optional: Redirect to designs page
    // window.location.href = 'designs.html';
}

// Update the existing save button to open modal instead
document.addEventListener('DOMContentLoaded', function() {
    const saveBtn = document.getElementById('save-config');
    if (saveBtn) {
        // Remove existing click listener
        const newSaveBtn = saveBtn.cloneNode(true);
        saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
        
        // Add new click listener
        newSaveBtn.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Check if we're in edit mode
            const isEditing = sessionStorage.getItem('isEditing') === 'true';
            const editDesignId = sessionStorage.getItem('editDesignId');
            
            if (isEditing && editDesignId) {
                // For edit mode, ask what to do
                const userChoice = confirm("You are editing an existing design. Do you want to:\n\n• 'OK' - Update the existing design\n• 'Cancel' - Save as a new design");
                
                if (userChoice) {
                    // Update existing design
                    updateExistingDesign(editDesignId);
                } else {
                    // Save as new design - open modal for label
                    openSwitchLabelModal();
                }
            } else {
                // Normal save - open modal for label
                openSwitchLabelModal();
            }
        });
    }
});

// Function to update existing design (for edit mode)
function updateExistingDesign(designId) {
    const switchLabel = prompt("Enter a new name/label for this updated design:", "Updated Design");
    
    if (!switchLabel) {
        alert('Please enter a name or label for this design.');
        return;
    }
    
    // Get current configuration
    const selectedColor = document.querySelector('.color-option.selected').getAttribute('data-color');
    const selectedColorName = document.querySelector('.color-option.selected').getAttribute('data-name');
    const selectedEngravingType = document.querySelector('.engraving-option.selected').getAttribute('data-type');
    
    // Get the preview HTML
    const square = document.querySelector('.square');
    const previewHTML = square.innerHTML;
    
    // Get text values
    const textValues = getTextValues();
    
    // Update the preview with switch label
    updatePreviewWithSwitchLabel(switchLabel);
    
    // Update design object
    const updatedDesign = {
        id: designId,
        color: selectedColor,
        colorName: selectedColorName,
        engravingType: selectedEngravingType,
        previewHTML: previewHTML,
        fileName: new Date().toLocaleString(),
        switchLabel: switchLabel,
        timestamp: new Date().toISOString(),
        textValues: textValues
    };
    
    // Get existing designs from localStorage
    let designs = JSON.parse(localStorage.getItem('lumiDesigns') || '[]');
    
    // Find and update the design
    const designIndex = designs.findIndex(d => d.id === designId);
    if (designIndex !== -1) {
        designs[designIndex] = updatedDesign;
        
        // Save back to localStorage
        localStorage.setItem('lumiDesigns', JSON.stringify(designs));
        
        // Clear edit mode data
        sessionStorage.removeItem('editDesignData');
        sessionStorage.removeItem('isEditing');
        sessionStorage.removeItem('editDesignId');
        
        alert(`Design updated successfully with label: "${switchLabel}"`);
        
        // Redirect to designs page
        setTimeout(() => {
            window.location.href = 'designs.html';
        }, 1000);
    } else {
        alert('Design not found! Saving as new design.');
        openSwitchLabelModal();
    }
}

// Close modal when clicking outside
window.addEventListener('click', (e) => {
    const modal = document.getElementById('switchLabelModal');
    if (e.target === modal) {
        closeSwitchLabelModal();
    }
});

    </script>

</body>

</html>